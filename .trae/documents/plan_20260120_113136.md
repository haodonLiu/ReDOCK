# 实现构象预生成和评估流程

## 1. 问题分析
用户要求在optimize_position之前添加一个环节，实现以下功能：
- 以受体蛋白为圆心
- 两个蛋白之间距离为半径
- 沿着z轴x轴交叉面生成一圈的配体构象
- 比较每个构象，选择最合适的构象

## 2. 解决方案

### 2.1 新增方法设计
在`Docking`类中新增`generate_initial_conformations`方法，实现以下功能：

#### 方法功能
- 以受体蛋白为圆心
- 计算初始半径（两个蛋白之间的距离）
- 沿着z轴x轴交叉面生成一圈配体构象
- 评估每个构象的能量和距离
- 选择最合适的构象作为初始位置

#### 实现步骤
1. **初始化**：
   - 获取受体中心位置
   - 计算初始半径
   - 确定生成构象的数量

2. **构象生成**：
   - 沿着z轴x轴交叉面（xz平面）生成均匀分布的角度
   - 对每个角度：
     - 计算配体在xz平面上的目标位置
     - 创建配体构象
     - 评估构象的能量和距离

3. **构象评估**：
   - 计算每个构象的范德华力
   - 计算配体目标基团与受体目标基团之间的距离
   - 综合评估构象质量

4. **选择最佳构象**：
   - 选择能量最低、距离最近的构象
   - 将配体设置为最佳构象的位置

### 2.2 流程集成
在`dock`方法中，在`align_proteins`之后、`optimize_position`之前添加对`generate_initial_conformations`方法的调用。

## 3. 代码修改

### 3.1 新增方法
在`src/core/docking.py`中添加`generate_initial_conformations`方法：

```python
def generate_initial_conformations(self, num_conformations: int = 36) -> None:
    """
    Generate initial conformations of ligand along xz plane around receptor.
    Evaluate each conformation and select the best one as initial position.
    
    Args:
        num_conformations (int): Number of conformations to generate (default: 36)
    """
    # 实现代码
```

### 3.2 修改dock方法
在`dock`方法中添加对`generate_initial_conformations`的调用：

```python
# Step 2: Align proteins
self.logger.section("Aligning Proteins")
self.align_proteins()

# Step 2.3: Generate initial conformations
self.logger.section("Generating Initial Conformations")
self.generate_initial_conformations()

# Step 2.5: Optimize position
self.logger.section("Optimizing Position")
self.optimize_position()
```

## 4. 关键技术点

### 4.1 构象生成
- 在xz平面上均匀生成角度（0到360度）
- 基于极坐标计算配体的目标位置
- 保持配体的内部结构不变

### 4.2 构象评估
- 计算每个构象的范德华力
- 计算配体目标基团与受体目标基团之间的距离
- 综合考虑能量和距离，选择最佳构象

### 4.3 性能优化
- 批量生成构象，减少重复计算
- 使用并行计算评估构象（如果可能）
- 提前过滤明显不好的构象

## 5. 预期效果

- 生成多个初始构象，增加找到全局最优解的机会
- 选择能量最低、距离最近的构象作为初始位置
- 为后续的optimize_position提供更好的起点
- 提高对接计算的效率和准确性